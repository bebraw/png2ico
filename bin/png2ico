#!/usr/bin/env node
var path = require('path');
var im = require('imagemagick');
var ioscript = require('ioscript.js');


// http://stackoverflow.com/questions/3185677/converting-gifs-pngs-and-jpgs-to-ico-files-using-imagemagick
ioscript({
    version: require('../package.json').version,
    args: process.argv,
    limit: 10,
    transform: function(o, input, output, file, cb) {
        var outPath = path.join(output, path.basename(file, path.extname(file))) + '.ico';

        isPng(input, function(err) {
            if(err) cb();
            else toIco(input, outPath, cb);
        });
   }
});

function isPng(input, cb) {
    im.identify(input, function(err, features) {
        if(err) cb(err);
        if(features.format == 'PNG') cb();

        cb('Wrong format');
    });
}

function toIco(input, output, cb) {
    im.convert([input,
        '-resize', 'x16',
        '-gravity', 'center',
        '-background', 'transparent',
        '-crop', '16x16+0+0',
        '-colors', '256',
        '-flatten',
        output
    ], cb);
}
